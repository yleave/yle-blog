---
slug: js-execution-context
title: JSè¯æ³•ä½œç”¨åŸŸã€æ‰§è¡Œä¸Šä¸‹æ–‡ä¸é—­åŒ…
---

import Highlight from '@site/src/components/Highlight';
import { BlogComponent } from '@site/src/components/CustomComponent';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Comment from '@site/src/components/Comment';
import MarkdownInCollapse from '@site/src/components/MarkdownInCollapse';

<BlogComponent tags={['è¯æ³•ä½œç”¨åŸŸ', 'æ‰§è¡Œä¸Šä¸‹æ–‡', 'é—­åŒ…', 'ä½œç”¨åŸŸé“¾']} time="2021-05-28" />


## è¯æ³•ä½œç”¨åŸŸ

&emsp;&emsp;JS ä½¿ç”¨çš„æ˜¯**è¯æ³•ä½œç”¨åŸŸï¼ˆæˆ–ç§°ä¸ºé™æ€ä½œç”¨åŸŸï¼‰**ï¼Œ**å‡½æ•°çš„ä½œç”¨åŸŸåœ¨å®šä¹‰çš„æ—¶å€™å°±å†³å®šäº†**ï¼Œä¸è¯æ³•ä½œç”¨åŸŸç›¸å¯¹çš„æ˜¯**åŠ¨æ€ä½œç”¨åŸŸ**ï¼ŒåŠ¨æ€ä½œç”¨åŸŸä¼šåœ¨è¿è¡Œæ—¶ç¡®å®šçš„ã€‚

&emsp;&emsp;ä¸€ä¸ªã€ŠJSæƒå¨æŒ‡å—ã€‹ä¸­çš„ä¾‹å­ï¼š

```js
var scope = "global scope";
function checkscope(){
    var scope = "local scope";
    function f(){
        return scope;
    }
    return f();
}
checkscope();
```

```js
var scope = "global scope";
function checkscope(){
    var scope = "local scope";
    function f(){
        return scope;
    }
    return f;
}
checkscope()();
```


<MarkdownInCollapse markdown={`
  ä¸¤æ®µä»£ç çš„æ‰§è¡Œç»“æœéƒ½æ˜¯ï¼š"local scope"
  `}
  header="ä»£ç æ‰§è¡Œç»“æœğŸ‘‡" />

&emsp;&emsp;è¿™ä¹Ÿè¡¨æ˜äº†JS çš„ä½œç”¨åŸŸæ˜¯é™æ€ä½œç”¨åŸŸã€‚

&emsp;&emsp;å¼•ç”¨ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹çš„å›ç­”å°±æ˜¯ï¼š

> &emsp;&emsp;JavaScript å‡½æ•°çš„æ‰§è¡Œç”¨åˆ°äº†ä½œç”¨åŸŸé“¾ï¼Œè¿™ä¸ªä½œç”¨åŸŸé“¾æ˜¯åœ¨å‡½æ•°å®šä¹‰çš„æ—¶å€™åˆ›å»ºçš„ã€‚åµŒå¥—çš„å‡½æ•° `f()` å®šä¹‰åœ¨è¿™ä¸ªä½œç”¨åŸŸé“¾é‡Œï¼Œå…¶ä¸­çš„å˜é‡ scope ä¸€å®šæ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ç®¡ä½•æ—¶ä½•åœ°æ‰§è¡Œå‡½æ•° `f()`ï¼Œè¿™ç§ç»‘å®šåœ¨æ‰§è¡Œ `f()` æ—¶ä¾ç„¶æœ‰æ•ˆã€‚





## æ‰§è¡Œä¸Šä¸‹æ–‡ä¸è¯æ³•ç¯å¢ƒ

&emsp;&emsp;JS ä¸­æœ‰ä¸€ä¸ªæ‰§è¡Œè°ƒç”¨æ ˆå’Œæ‰§è¡Œä¸Šä¸‹æ–‡çš„æ¦‚å¿µï¼Œæ‰§è¡Œæ ˆæ˜¯ä¸€ä¸ªå…ˆè¿›åå‡ºçš„æ•°æ®ç»“æ„ï¼ŒJSåœ¨æ‰§è¡Œæ¯ä¸ªå‡½æ•°çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¹¶å°†å…¶å‹å…¥æ‰§è¡Œæ ˆä¸­ï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œåæ‰å°†å…¶ä»æ‰§è¡Œæ ˆä¸­å¼¹å‡ºã€‚æ‰§è¡Œæ ˆæœ€å¼€å§‹å‹å…¥çš„æ˜¯å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¯ä»¥çœ‹ä½œæ˜¯æœ€å¤–å±‚çš„ JS ä»£ç ç¯å¢ƒã€‚



**å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯åœ¨å‡½æ•°è¢«æ‰§è¡Œçš„æ—¶å€™æ‰åˆ›å»ºçš„ã€‚**



**æ‰§è¡Œä¸Šä¸‹æ–‡**çš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

1. åˆ›å»ºé˜¶æ®µ
2. æ‰§è¡Œé˜¶æ®µ



ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ä¼šç”±å‡ éƒ¨åˆ†ç»„æˆï¼š

1. è¯æ³•ç¯å¢ƒï¼ˆLexical Environmentï¼‰
2. å˜é‡ç¯å¢ƒï¼ˆVariable Environmentï¼‰ï¼Œä¹Ÿæ˜¯ä¸€ç§è¯æ³•ç¯å¢ƒ
3. this ç»‘å®šï¼ˆThis Bindingï¼‰

è¯æ³•ç¯å¢ƒ & å˜é‡ç¯å¢ƒä¸­åˆåŒ…å«äº†ï¼š

1. ç¯å¢ƒè®°å½•ï¼ˆEnvironmentRecordï¼‰ï¼Œä¸€ä¸ªå­˜å‚¨æ‰€æœ‰å±€éƒ¨å˜é‡ä½œä¸ºå…¶å±æ€§çš„å¯¹è±¡ã€‚
2. æŒ‡å‘å¤–éƒ¨ç¯å¢ƒçš„æŒ‡é’ˆï¼ˆouterï¼‰ï¼Œå…¨å±€ç¯å¢ƒæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„ outer ä¸º `null`



&emsp;&emsp;è¯æ³•ç¯å¢ƒå’Œå˜é‡ç¯å¢ƒä¿å­˜äº†å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡å’Œå‡½æ•°çš„æ ‡è¯†ã€‚

&emsp;&emsp;åœ¨æ‰§è¡Œé˜¶æ®µï¼Œè¿™ä¸‰ä¸ªéƒ¨åˆ†éƒ½ä¼šè¢«ç¡®å®šï¼Œè¯æ³•ç¯å¢ƒå’Œå˜é‡ç¯å¢ƒä¸­çš„å˜é‡ä¼šè¢«åˆå§‹åŒ–ï¼Œç›´åˆ°æ‰§è¡Œé˜¶æ®µæ‰ä¼šè¢«çœŸæ­£èµ‹å€¼ã€‚

> ç½‘ä¸Šæ–‡ç« ä¸­ç»å¸¸çœ‹åˆ°çš„å˜é‡å¯¹è±¡ï¼ˆVariable Objectï¼ŒAOï¼‰å’Œæ´»è·ƒå¯¹è±¡ï¼ˆActivation Objectï¼ŒAOï¼‰ å®é™…ä¸Šæ˜¯ ES1/ES3 ä¸­çš„å†…å®¹ï¼Œåœ¨ ES5 åŠä»¥åçš„ç‰ˆæœ¬ä¸­å·²ç»ä¸å­˜åœ¨ AO åŠä¸€ç³»åˆ—ç›¸å…³æ¦‚å¿µäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªå«è¯æ³•ç¯å¢ƒï¼ˆLexical Environmentï¼‰çš„å®šä¹‰ã€‚
>
> å…³äºè¯æ³•ç¯å¢ƒï¼Œå¤§å¯ä»¥å‚é˜…ï¼š
>
> - [ECMA-262-5 in detail. Chapter 3.2. Lexical environments: ECMAScript implementation](http://dmitrysoshnikov.com/ecmascript/es5-chapter-3-2-lexical-environments-ecmascript-implementation/).
> - [csdn ECMA-262-5 è¯æ³•ç¯å¢ƒï¼šECMAå®ç°](https://blog.csdn.net/szengtal/article/details/78726143)



&emsp;&emsp;åœ¨ ES6 ä¸­ï¼Œè¯æ³•ç¯å¢ƒå’Œå˜é‡ç¯å¢ƒçš„åŒºåˆ«åœ¨äº **è¯æ³•ç¯å¢ƒç”¨äºå­˜å‚¨å‡½æ•°å’Œä½¿ç”¨ `let` å’Œ `const` å£°æ˜çš„å˜é‡**ï¼Œè€Œ**å˜é‡ç¯å¢ƒä»…ç”¨äºå­˜å‚¨ä½¿ç”¨ `var` å£°æ˜çš„å˜é‡ã€‚**

&emsp;&emsp;å¯¹äº**å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡**æ¥è¯´ï¼Œå‡½æ•°ä¼ å…¥çš„**å‚æ•°**ä¹Ÿä¼šè¢«ä¿å­˜åœ¨**è¯æ³•ç¯å¢ƒ**ä¸­ã€‚



ä¸¾ä¸ªä¾‹å­ï¼š


<Tabs
  defaultValue="JS"
  values={[
    {label: 'JS', value: 'JS'},
    {label: 'å¯¹åº”æ‰§è¡Œä¸Šä¸‹æ–‡', value: 'execContext'},
  ]}>
  <TabItem value="JS">

```js
let a = 20;  
const b = 30;  
var c;

function multiply(e, f) {  
 var g = 20;  
 return e * f * g;  
}

c = multiply(20, 30);
```
  </TabItem>
  <TabItem value="execContext">

```js
// é¦–å…ˆä¼šæœ‰ä¸€ä¸ªå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡
GlobalExectionContext = {
  ThisBinding: <Global Object>,

  LexicalEnvironment: {  
    EnvironmentRecord: {  
      Type: "Object",  
      // æ ‡è¯†ç¬¦ç»‘å®šåœ¨è¿™é‡Œ  
      a: < uninitialized >,  
      b: < uninitialized >,  
      multiply: < func >  
    }  
    outer: <null>  
  },

  VariableEnvironment: {  
    EnvironmentRecord: {  
      Type: "Object",  
      // æ ‡è¯†ç¬¦ç»‘å®šåœ¨è¿™é‡Œ  
      c: undefined,  
    }  
    outer: <null>  
  }  
}

FunctionExectionContext = {  
   
  ThisBinding: <Global Object>,

  LexicalEnvironment: {  
    EnvironmentRecord: {  
      Type: "Declarative",  
      // æ ‡è¯†ç¬¦ç»‘å®šåœ¨è¿™é‡Œ  
      Arguments: {0: 20, 1: 30, length: 2},  
    },  
    outer: <GlobalLexicalEnvironment>  
  },

  VariableEnvironment: {  
    EnvironmentRecord: {  
      Type: "Declarative",  
      // æ ‡è¯†ç¬¦ç»‘å®šåœ¨è¿™é‡Œ  
      g: undefined  
    },  
    outer: <GlobalLexicalEnvironment>  
  }  
}
```

  </TabItem>
</Tabs>


&emsp;&emsp;æ‰§è¡Œä¸Šä¸‹æ–‡åœ¨åˆ›å»ºé˜¶æ®µå°±ç»‘å®šçš„å‡½æ•°å’Œå˜é‡ä¹Ÿå°±æ˜¯æˆ‘ä»¬è§‚å¯Ÿåˆ°çš„**å˜é‡æå‡/å‡½æ•°æå‡**çš„åŸå› ã€‚

&emsp;&emsp;æ³¨æ„åˆ°è¯æ³•ç¯å¢ƒå’Œå˜é‡ç¯å¢ƒä¸­å˜é‡çš„åˆå§‹åŒ–åˆ†åˆ«æ˜¯ `uninitialized` å’Œ `undefined`ï¼Œå› æ­¤å¯¹äº `let` å’Œ `const` å£°æ˜çš„å˜é‡ï¼Œè‹¥åœ¨èµ‹å€¼ä¹‹å‰ä½¿ç”¨çš„è¯ä¼šæŠ¥ `Reference Error` ï¼Œè€Œå¯¹äº `var` å£°æ˜çš„å˜é‡åˆ™ä¼šæ˜¯ `undefined`ã€‚



&emsp;&emsp;è€Œå‡½æ•°çš„å˜é‡æå‡ä¼˜å…ˆçº§ä¼šé«˜äºå˜é‡æå‡ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ‰§è¡Œä¸Šä¸‹æ–‡åˆ›å»ºé˜¶æ®µï¼š

1. å¯¹å‡½æ•°çš„æ‰€æœ‰å½¢å‚ï¼ˆè‹¥æ˜¯å‡½æ•°ä¸Šä¸‹æ–‡ï¼‰
   - ç”±åç§°å’Œå¯¹åº”å€¼ç»„æˆçš„ä¸€ä¸ªå˜é‡å¯¹è±¡çš„å±æ€§è¢«åˆ›å»º
   - è‹¥æ²¡æœ‰å®å‚ï¼Œå±æ€§å€¼è®¾ä¸º `undefined`
2. å¯¹å‡½æ•°å£°æ˜
   - ç”±åç§°å’Œå¯¹åº”å€¼ï¼ˆå‡½æ•°å¯¹è±¡ï¼‰ç»„æˆçš„ä¸€ä¸ªå˜é‡å¯¹è±¡çš„å±æ€§è¢«åˆ›å»º
   - å¦‚æœå˜é‡å¯¹è±¡å·²ç»å­˜åœ¨ç›¸åŒåç§°çš„å±æ€§ï¼Œåˆ™**å®Œå…¨æ›¿æ¢**è¿™ä¸ªå±æ€§
3. å¯¹å˜é‡å£°æ˜
   - ç”±åç§°å’Œå¯¹åº”å€¼ï¼ˆ`undefined` æˆ– `uninitialized`ï¼‰ç»„æˆçš„ä¸€ä¸ªå˜é‡å¯¹è±¡çš„å±æ€§è¢«åˆ›å»º
   - å¯¹äº `var` å£°æ˜çš„å˜é‡ï¼Œå¦‚æœå˜é‡åç§°å’Œå·²ç»å£°æ˜çš„å½¢å¼å‚æ•°æˆ–å‡½æ•°ç›¸åŒï¼Œåˆ™å˜é‡å£°æ˜ä¸ä¼šå¹²æ‰°å·²å­˜åœ¨çš„è¿™ç±»å±æ€§ï¼›è€Œè‹¥æ˜¯ `let` æˆ– `const` å£°æ˜çš„å¯¹è±¡ï¼Œè‹¥å·²å­˜åœ¨åŒåå¯¹è±¡åˆ™ä¼šæŠ¥é”™ã€‚



&emsp;&emsp;å¯ä»¥ä½¿ç”¨å‡ ä¸ªä¾‹å­æ¥è¿›è¡ŒéªŒè¯ï¼š


1. å‡½æ•°æå‡ä¼˜å…ˆçº§å¤§äºå˜é‡æå‡ï¼š

```js
console.log(a)	// æ‰“å°å‡½æ•° a

function a() {}

var a = 3;
```

2. å¯¹å‡½æ•°å£°æ˜ï¼Œè‹¥å·²å­˜åœ¨åŒåå±æ€§åˆ™ä¼šå®Œå…¨æ›¿æ¢ï¼š

```js
console.log(a)	// æ‰“å°ç¬¬äºŒä¸ªå®šä¹‰çš„å‡½æ•° a

function a() {}

function a() {
    console.log(a)
}

console.log(a)	// æ‰“å°ç¬¬äºŒä¸ªå®šä¹‰çš„å‡½æ•° a
```

3. å¯¹äºä½¿ç”¨ `var` çš„å˜é‡å£°æ˜ï¼Œè‹¥å·²å­˜åœ¨åŒåå±æ€§ï¼Œåˆ™ä¸ä¼šè¿›è¡Œå¹²æ‰°ï¼š

```js
console.log(a)

function a() {}

var a = 3;
var a = 4;

// ä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œ...
```


å†çœ‹ä¸€é“é¢˜ï¼š

```js
function foo() {
    console.log(a);
    a = 1;
}

foo(); // ???

function bar() {
    a = 1;
    console.log(a);
}
bar(); // ???
```

<MarkdownInCollapse markdown={`
  &emsp;&emsp;foo æ‰§è¡Œæ—¶ä¼šæŠ¥é”™ï¼šReferenceError: a is not definedï¼Œè¿™æ˜¯å› ä¸ºå˜é‡ a å¹¶æ²¡æœ‰ä½¿ç”¨ var å£°æ˜ï¼Œå› æ­¤å®ƒåœ¨æ‰§è¡Œä¸Šä¸‹æ–‡åˆ›å»ºé˜¶æ®µä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼ˆundefinedï¼‰ï¼Œè¿›è€ŒæŠ¥é”™ã€‚
  
  &emsp;&emsp;bar æ‰§è¡Œåä¼šæ‰“å° 1ã€‚è™½ç„¶ a ä¹Ÿæ²¡æœ‰ä½¿ç”¨ var å…³é”®å­—ç”³æ˜ï¼Œä½†åœ¨æ‰“å° a çš„æ—¶å€™å·²ç»å¯¹å…¶è¿›è¡Œäº†èµ‹å€¼ï¼Œå› æ­¤ä¸ä¼šæŠ¥é”™ã€‚
  `}
  header="è§£æğŸ‘‡" />


&emsp;&emsp;**å¦å¤–ï¼Œå¯¹äºè¿™ç±»åœ¨å‡½æ•°ä¸­æ²¡æœ‰ä½¿ç”¨å…³é”®å­—å£°æ˜çš„å˜é‡ï¼Œä¼šè¢«è®¾ç½®ä¸ºå…¨å±€å˜é‡ï¼Œå¯¼è‡´å…¨å±€ç¯å¢ƒæ±¡æŸ“ä»¥åŠå†…å­˜æ³„æ¼ï¼š**

```js
function bar() {
    a = 1;
    console.log(a);
}
bar();

console.log(window.a);	// 1
```



## é—­åŒ…

&emsp;&emsp;å¼•ç”¨çº¢çš®ä¹¦ä¸Šå¯¹é—­åŒ…çš„é™ˆè¿°ï¼š

> é—­åŒ…æ˜¯æŒ‡æœ‰æƒè®¿é—®å¦ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸä¸­çš„å˜é‡çš„å‡½æ•°ã€‚

&emsp;&emsp;æœ‰ä¸¤ä¸ªè¦ç‚¹ï¼š

- é—­åŒ…æ˜¯å‡½æ•°
- å®ƒå¯ä»¥è®¿é—®å¦ä¸€ä¸ªå‡½æ•°çš„ä½œç”¨åŸŸä¸­çš„å˜é‡

&emsp;&emsp;æ ¹æ®è¿™ä¸ªå®šä¹‰ï¼Œå…¶å® JS ä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½æ˜¯é—­åŒ…ï¼Œä¸è¿‡æˆ‘ä»¬é€šå¸¸è¯´é—­åŒ…æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªå‡½æ•°ä¸­è¿”å›å¦ä¸€ä¸ªå‡½æ•°çš„æƒ…å†µï¼Œè¿™ä¸ªè¢«è¿”å›çš„å‡½æ•°æˆ‘ä»¬å°±å«å®ƒé—­åŒ…ã€‚

&emsp;&emsp;è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿å¤–éƒ¨å‡½æ•°çš„è°ƒç”¨å·²ç»“æŸï¼Œä½†é—­åŒ…ä»èƒ½è®¿é—®åˆ°å…¶å†…éƒ¨çš„å˜é‡å’Œå‚æ•°ã€‚



æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```js
function makeCounter() {
  let count = 0;

  return function() {
    return count++;
  };
}

let counter = makeCounter();
```

&emsp;&emsp;åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`counter` å°±æ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‰€æŒ‡çš„**é—­åŒ…**ï¼Œä¸”æ¯æ¬¡è°ƒç”¨ `counter`ï¼Œå°±èƒ½è·å¾— `count` å€¼ï¼Œç„¶å `count` ä¼šè‡ªå¢ã€‚

&emsp;&emsp;åœ¨æ¯æ¬¡ `makeCounter()` è°ƒç”¨çš„å¼€å§‹ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª**æ–°çš„**è¯æ³•ç¯å¢ƒå¯¹è±¡ï¼Œä»¥å­˜å‚¨è¯¥ `makeCounter` è¿è¡Œæ—¶çš„å˜é‡ã€‚

&emsp;&emsp;æ ¹æ®æˆ‘ä»¬ä¸Šé¢å¯¹æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä»‹ç»å¯ä»¥çŸ¥é“ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼Œå®ƒæœ‰ä¸¤å±‚åµŒå¥—çš„è¯æ³•ç¯å¢ƒï¼š

<img src="https://gitee.com/yleave/imagehost1/raw/master/img/image-20210528192626093.png" alt="image-20210528192626093" style={{zoom:"80%"}} />

&emsp;&emsp;å½“æ‰§è¡Œ `makeCounter` å‡½æ•°æ—¶ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œæ­¤æ—¶è¿™ä¸ªåŒ¿åå‡½æ•°è¿˜æœªè¿è¡Œã€‚

&emsp;&emsp;è€Œæ‰€æœ‰å‡½æ•°åœ¨åˆ›å»ºæ—¶éƒ½ä¼šæœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘åˆ›å»ºå®ƒçš„å¤–éƒ¨ç¯å¢ƒï¼š`[[Environment]]`ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„ `outer`ï¼‰ï¼Œå³ä½¿ `makeCounter` ç»“æŸï¼Œè¿™ä¸ªå¼•ç”¨ä¹Ÿä»ç„¶å­˜åœ¨ã€‚

<img src="https://gitee.com/yleave/imagehost1/raw/master/img/image-20210528192917079.png" alt="image-20210528192917079" style={{zoom:"80%"}} />

&emsp;&emsp;ç°åœ¨ï¼Œå½“ `counter()` ä¸­çš„ä»£ç æŸ¥æ‰¾ `count` å˜é‡æ—¶ï¼Œå®ƒé¦–å…ˆæœç´¢è‡ªå·±çš„è¯æ³•ç¯å¢ƒï¼ˆä¸ºç©ºï¼Œå› ä¸ºé‚£é‡Œæ²¡æœ‰å±€éƒ¨å˜é‡ï¼‰ï¼Œç„¶åæ˜¯å¤–éƒ¨ `makeCounter()` çš„è¯æ³•ç¯å¢ƒï¼Œå¹¶ä¸”åœ¨å“ªé‡Œæ‰¾åˆ°å°±åœ¨å“ªé‡Œä¿®æ”¹ã€‚**å³åœ¨å˜é‡æ‰€åœ¨çš„è¯æ³•ç¯å¢ƒä¸­æ›´æ–°å˜é‡ã€‚**

<img src="https://gitee.com/yleave/imagehost1/raw/master/img/image-20210528193440752.png" alt="image-20210528193440752" style={{zoom:"80%"}} />


:::note é—­åŒ…ä¸åƒåœ¾å›æ”¶æœºåˆ¶

&emsp;&emsp;é—­åŒ…æ‰€æŒ‡å‘çš„è¯æ³•ç¯å¢ƒèƒ½å¤Ÿå­˜åœ¨ä¸ JS å¼•æ“çš„åƒåœ¾å›æ”¶æœºåˆ¶ä¹Ÿæœ‰å…³ç³»ï¼š

&emsp;&emsp;é€šå¸¸ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆåï¼Œä¼šå°†è¯æ³•ç¯å¢ƒå’Œå…¶ä¸­çš„æ‰€æœ‰å˜é‡ä»å†…å­˜ä¸­åˆ é™¤ã€‚å› ä¸ºç°åœ¨æ²¡æœ‰ä»»ä½•å¯¹å®ƒä»¬çš„å¼•ç”¨äº†ã€‚ä¸ JavaScript ä¸­çš„ä»»ä½•å…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œè¯æ³•ç¯å¢ƒä»…åœ¨å¯è¾¾æ—¶æ‰ä¼šè¢«ä¿ç•™åœ¨å†…å­˜ä¸­ã€‚

&emsp;&emsp;ä½†æ˜¯ï¼Œå¦‚æœæœ‰ä¸€ä¸ªåµŒå¥—çš„å‡½æ•°åœ¨å‡½æ•°ç»“æŸåä»å¯è¾¾ï¼Œåˆ™å®ƒå°†å…·æœ‰å¼•ç”¨è¯æ³•ç¯å¢ƒçš„ `[[Environment]]` å±æ€§ã€‚

:::


:::info é—­åŒ…åœ¨å®é™…å¼€å‘ä¸­çš„ä¼˜åŒ–

&emsp;&emsp;å…³äºé—­åŒ…æ‰€è®¿é—®çš„å¤–éƒ¨ç¯å¢ƒä¸­çš„å˜é‡ï¼Œåœ¨å®é™…ä¸­ï¼ŒJavaScript å¼•æ“ä¼šè¯•å›¾ä¼˜åŒ–å®ƒã€‚å®ƒä»¬ä¼šåˆ†æå˜é‡çš„ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœä»ä»£ç ä¸­å¯ä»¥æ˜æ˜¾çœ‹å‡ºæœ‰æœªä½¿ç”¨çš„å¤–éƒ¨å˜é‡ï¼Œé‚£ä¹ˆå°±ä¼šå°†å…¶åˆ é™¤ã€‚

&emsp;&emsp;å› æ­¤ï¼Œ**åœ¨ V8ï¼ˆChromeï¼ŒEdgeï¼ŒOperaï¼‰ä¸­çš„ä¸€ä¸ªé‡è¦çš„å‰¯ä½œç”¨æ˜¯ï¼Œæ­¤ç±»å˜é‡åœ¨è°ƒè¯•ä¸­å°†ä¸å¯ç”¨ã€‚**

&emsp;&emsp;å…·ä½“å¯çœ‹ï¼š[å®é™…å¼€å‘ä¸­çš„ä¼˜åŒ–](https://zh.javascript.info/closure#shi-ji-kai-fa-zhong-de-you-hua)

:::


### é—­åŒ…ç»ƒä¹ 

1. Counter æ˜¯ç‹¬ç«‹çš„å—ï¼Ÿ

```js {15,16}
function makeCounter() {
  let count = 0;

  return function() {
    return count++;
  };
}

let counter = makeCounter();
let counter2 = makeCounter();

alert( counter() ); // 0
alert( counter() ); // 1

alert( counter2() ); // ?
alert( counter2() ); // ?
```

<MarkdownInCollapse markdown={`
  &emsp;&emsp;ç­”æ¡ˆæ˜¯ 0, 1
  
  &emsp;&emsp;å› ä¸ºæ¯æ¬¡æ‰§è¡Œ makeCounter æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥ counterã€counter2 ä¸­çš„ [[Environment]] æ‰€å¼•ç”¨çš„è¯æ³•ä½œç”¨åŸŸæ˜¯ä¸åŒçš„
  `}
  header="è§£æğŸ‘‡" />

2. Counter å¯¹è±¡

&emsp;&emsp;è¿™é‡Œé€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª counter å¯¹è±¡ã€‚

&emsp;&emsp;å®ƒèƒ½æ­£å¸¸å·¥ä½œå—ï¼Ÿå®ƒä¼šæ˜¾ç¤ºä»€ä¹ˆå‘¢ï¼Ÿ

```js {14-16}
function Counter() {
  let count = 0;

  this.up = function() {
    return ++count;
  };
  this.down = function() {
    return --count;
  };
}

let counter = new Counter();

alert( counter.up() ); // ?
alert( counter.up() ); // ?
alert( counter.down() ); // ?
```

<MarkdownInCollapse markdown={`
  &emsp;&emsp;èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä¸”ç­”æ¡ˆåˆ†åˆ«æ˜¯ï¼š 1ï¼Œ 2ï¼Œ 1ã€‚
  
  &emsp;&emsp;å› ä¸ºå†…éƒ¨å‡½æ•° up å’Œ down éƒ½æ˜¯åœ¨åŒä¸€ä¸ªè¯æ³•ç¯å¢ƒä¸­åˆ›å»ºçš„ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥å…±äº«å¯¹åŒä¸€ä¸ª count å˜é‡çš„è®¿é—®ã€‚
  `}
  header="è§£æğŸ‘‡" />

3. sum

&emsp;&emsp;ç¼–å†™ä¸€ä¸ªåƒ `sum(a)(b) = a+b` è¿™æ ·å·¥ä½œçš„ `sum` å‡½æ•°ã€‚

```js
sum(1)(2) = 3
sum(5)(-1) = 4
```

<MarkdownInCollapse markdown={`
  &emsp;&emsp;ä¸ºäº†ä½¿ç¬¬äºŒä¸ªæ‹¬å·æœ‰æ•ˆï¼Œç¬¬ä¸€ä¸ªï¼ˆæ‹¬å·ï¼‰å¿…é¡»è¿”å›ä¸€ä¸ªå‡½æ•°ã€‚
  
  ~~~js
  function sum(a) {
    return function(b) {
      return a + b; // ä»å¤–éƒ¨è¯æ³•ç¯å¢ƒè·å¾— "a"
    };
  }
  ~~~
  `}
  header="è§£å†³æ–¹æ¡ˆğŸ‘‡" />

4. filter æ–¹æ³•

&emsp;&emsp;ç¼–å†™ `inBetween` å’Œ `inArray` æ–¹æ³•ï¼Œä½¿å¾— `Array.prototype.filter` èƒ½å¤Ÿåƒä¸‹é¢è¿™æ ·å·¥ä½œï¼š

- `arr.filter(inBetween(3,6))` â€”â€” åªæŒ‘é€‰èŒƒå›´åœ¨ `3` åˆ° `6` çš„å€¼ã€‚
- `arr.filter(inArray([1,2,3]))` â€”â€” åªæŒ‘é€‰ä¸ `[1,2,3]` ä¸­çš„å…ƒç´ åŒ¹é…çš„å…ƒç´ ã€‚

```js
/* .. inBetween å’Œ inArray çš„ä»£ç  */
let arr = [1, 2, 3, 4, 5, 6, 7];

alert( arr.filter(inBetween(3, 6)) ); // 3,4,5,6

alert( arr.filter(inArray([1, 2, 10])) ); // 1,2
```

<MarkdownInCollapse markdown={`
  &emsp;&emsp;è¦å†™è¿™é¢˜é¦–å…ˆè¦çŸ¥é“ [filter å‡½æ•°çš„å·¥ä½œåŸç†](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/filter)
  
~~~js
function inBetween(l, r) {
  return function(val) {
      return l <= val && val <= r;
  };
}
//
function inArray(arr) {
    return function(val) {
        // æˆ–ä½¿ç”¨ arr.includes(val)
        return arr.indexOf(val) !== -1;
    };
}
~~~
  `}
  header="è§£å†³æ–¹æ¡ˆğŸ‘‡" />

5. å‡½æ•°æ•°ç»„

&emsp;&emsp;æˆ‘ä»¬æƒ³ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ä¿å­˜ä¸€äº›å‡½æ•°ï¼Œå½“è°ƒç”¨è¿™äº›å‡½æ•°æ—¶è¾“å‡ºæˆ‘ä»¬å‡½æ•°å®šä¹‰æ—¶æƒ³è¦ä¿å­˜çš„å€¼ï¼Œä¸è¿‡ä¸‹é¢çš„ä»£ç å‡ºäº†é—®é¢˜ï¼Œå°†å®ƒä»¬ä¿®å¤ï¼š

```js
function makeArmy() {
  let shooters = [];

  let i = 0;
  while (i < 10) {
    let shooter = function() { // åˆ›å»ºä¸€ä¸ª shooter å‡½æ•°ï¼Œ
      alert( i ); // åº”è¯¥æ˜¾ç¤ºå…¶ç¼–å·
    };
    shooters.push(shooter); // å°†æ­¤ shooter å‡½æ•°æ·»åŠ åˆ°æ•°ç»„ä¸­
    i++;
  }

  // è¿”å›å‡½æ•°æ•°ç»„
  return shooters;
}

let army = makeArmy();

// â€¦â€¦æ‰€æœ‰çš„ shooter æ˜¾ç¤ºçš„éƒ½æ˜¯ 10ï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„ç¼–å· 0, 1, 2, 3...
army[0](); // ç¼–å·ä¸º 0 çš„ shooter æ˜¾ç¤ºçš„æ˜¯ 10
army[1](); // ç¼–å·ä¸º 1 çš„ shooter æ˜¾ç¤ºçš„æ˜¯ 10
army[2](); // 10ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯è¿™æ ·ã€‚
```

<MarkdownInCollapse markdown={`
  &emsp;&emsp;é¦–å…ˆï¼Œä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·çš„ç»“æœå‘¢ï¼Ÿ
  
  &emsp;&emsp; è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å®šä¹‰çš„æ¯ä¸ªå‡½æ•° shooter éƒ½æ˜¯åœ¨åŒä¸€ä¸ªè¯æ³•ä½œç”¨åŸŸä¸­çš„ï¼ˆmakeArmy çš„è¯æ³•ä½œç”¨åŸŸï¼‰ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬è°ƒç”¨è¿™äº›å‡½æ•°æ—¶ï¼Œè®¿é—®çš„éƒ½æ˜¯åŒä¸€ä¸ª iï¼Œè€Œæˆ‘ä»¬åœ¨æ‰§è¡Œå®Œ makeArmy å i å·²ç»åŠ åˆ° 10 äº†ã€‚
  &emsp;&emsp;é‚£ä¹ˆè§£å†³æ–¹æ¡ˆå°±å¾ˆæ˜æ˜¾äº†ï¼šåˆ›å»º 10 ä¸ªä¸åŒçš„å˜é‡æ¥ä¿å­˜è¿™äº›å€¼ã€‚
  
  ### æ–¹æ³•1ï¼šä½¿ç”¨ä¸­é—´å˜é‡
~~~js
function makeArmy() {
  let shooters = [];
  let i = 0;
  while (i < 10) {
    let temp = i; // æ¯ä¸ª while å¾ªç¯ä¸­éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å˜é‡ temp æ¥ä¿å­˜ i å½“å‰çš„å€¼
    let shooter = function() {
      console.log( temp );
    };
    shooters.push(shooter);
    i++;
  }
  return shooters;
}
~~~
  ### æ–¹æ³•2ï¼šä½¿ç”¨ for å¾ªç¯
~~~js
function makeArmy() {
  let shooters = [];
  // for å¾ªç¯ä¹Ÿæ˜¯åŒæ ·é“ç†ï¼Œæ¯æ¬¡å¾ªç¯ä¸­éƒ½æ˜¯ä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸ
  for (let i = 0; i < 10; ++i) {
    let shooter = function() {
      console.log( i );
    };
    shooters.push(shooter);
  }
  return shooters;
}
~~~
  `}
  header="è§£å†³æ–¹æ¡ˆğŸ‘‡" />



## ä½œç”¨åŸŸé“¾

> &emsp;&emsp;å½“æŸ¥æ‰¾å˜é‡çš„æ—¶å€™ï¼Œä¼šå…ˆä»å½“å‰ä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šä»çˆ¶çº§(è¯æ³•å±‚é¢ä¸Šçš„çˆ¶çº§)æ‰§è¡Œä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°å…¨å±€ä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å…¨å±€å¯¹è±¡ã€‚è¿™æ ·ç”±å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡æ„æˆçš„é“¾è¡¨å°±å«åšä½œç”¨åŸŸé“¾ã€‚

> &emsp;&emsp;ä½œç”¨åŸŸé“¾çš„æŸ¥æ‰¾æ–¹å¼å’ŒåŸå‹é“¾æœ‰ç‚¹ç±»ä¼¼ï¼Œä¸åŒç‚¹æ˜¯ï¼šåŸå‹é“¾æŸ¥æ‰¾è‹¥æ‰¾ä¸åˆ°æŒ‡å®šçš„å˜é‡ï¼Œåˆ™è¿”å› `undefined`ï¼Œè€Œä½œç”¨åŸŸé“¾æŸ¥æ‰¾ï¼Œæœªæ‰¾åˆ°å˜é‡å€¼çš„è¯åˆ™ä¼šæŠ¥é”™ï¼š`ReferenceError`

&emsp;&emsp;JS ä¸­ä½¿ç”¨çš„æ˜¯è¯æ³•ä½œç”¨åŸŸï¼Œåœ¨å‡½æ•°å®šä¹‰çš„æ—¶å€™ï¼ˆè¿˜æœªæ‰§è¡Œï¼‰å°±ä¼šç¡®å®šäº†ä¸€ä¸ªåˆå§‹çš„ä½œç”¨åŸŸé“¾ï¼Œç„¶ååœ¨å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ä¼šå†æ¬¡è¿›è¡Œæ›´æ–°ã€‚



&emsp;&emsp;å‡½æ•°å†…éƒ¨æœ‰ä¸€ä¸ªå±æ€§ `[[scope]]`ï¼Œç”¨äºä¿å­˜å‡½æ•°æ‰€èƒ½è®¿é—®åˆ°çš„ä½œç”¨åŸŸï¼Œä½œç”¨åŸŸçš„é¡¶ç«¯æ˜¯å…¨å±€ä½œç”¨åŸŸã€‚

&emsp;&emsp;å½“å‡½æ•°æ‰§è¡Œè¿›å…¥æ‰§è¡Œä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šå°†å½“å‰ç¯å¢ƒå¯¹è±¡åŠ å…¥ä½œç”¨åŸŸé“¾é¡¶ç«¯ã€‚

&emsp;&emsp;ç”¨ä¼ªä»£ç æ¥è¡¨ç¤ºå°±æ˜¯ï¼š

```js
Scope = [curentEnv].concat([[scope]]);
```



&emsp;&emsp;å¦å¤–ï¼Œå¼•ç”¨ä¸€ä¸ªå›ç­”å¸®åŠ©ç†è§£ï¼š

> &emsp;&emsp;åœ¨æºä»£ç ä¸­å½“ä½ å®šä¹‰ï¼ˆä¹¦å†™ï¼‰ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼ˆå¹¶æœªè°ƒç”¨ï¼‰ï¼Œjså¼•æ“ä¹Ÿèƒ½æ ¹æ®ä½ å‡½æ•°ä¹¦å†™çš„ä½ç½®ï¼Œå‡½æ•°åµŒå¥—çš„ä½ç½®ï¼Œç»™ä½ ç”Ÿæˆä¸€ä¸ª[[scope]]ï¼Œä½œä¸ºè¯¥å‡½æ•°çš„å±æ€§å­˜åœ¨ï¼ˆè¿™ä¸ªå±æ€§å±äºå‡½æ•°çš„ï¼‰ã€‚å³ä½¿å‡½æ•°ä¸è°ƒç”¨ï¼Œæ‰€ä»¥è¯´åŸºäºè¯æ³•ä½œç”¨åŸŸï¼ˆé™æ€ä½œç”¨åŸŸï¼‰ã€‚
>
> &emsp;&emsp;ç„¶åè¿›å…¥å‡½æ•°æ‰§è¡Œé˜¶æ®µï¼Œç”Ÿæˆæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡ä½ å¯ä»¥å®è§‚çš„çœ‹æˆä¸€ä¸ªå¯¹è±¡ï¼Œï¼ˆåŒ…å«vo,scope,thisï¼‰ï¼Œæ­¤æ—¶ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡é‡Œçš„scopeå’Œä¹‹å‰å±äºå‡½æ•°çš„é‚£ä¸ª[[scope]]ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡é‡Œçš„scopeï¼Œæ˜¯åœ¨ä¹‹å‰å‡½æ•°çš„[[scope]]çš„åŸºç¡€ä¸Šï¼Œåˆæ–°å¢ä¸€ä¸ªå½“å‰çš„AOå¯¹è±¡æ„æˆçš„ã€‚
>
> &emsp;&emsp;**å‡½æ•°å®šä¹‰æ—¶å€™çš„[[scope]]å’Œå‡½æ•°æ‰§è¡Œæ—¶å€™çš„scopeï¼Œå‰è€…ä½œä¸ºå‡½æ•°çš„å±æ€§ï¼Œåè€…ä½œä¸ºå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡çš„å±æ€§ã€‚**
>
> &emsp;&emsp;å…¶ä¸­ï¼ŒAO å¯ä»¥çœ‹ä½œæ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„ **è¯æ³•ç¯å¢ƒ**


## REF

- [JavaScriptæ·±å…¥ä¹‹è¯æ³•ä½œç”¨åŸŸå’ŒåŠ¨æ€ä½œç”¨åŸŸ](https://github.com/mqyqingfeng/Blog/issues/3)
- [JavaScriptæ·±å…¥ä¹‹å˜é‡å¯¹è±¡](https://github.com/mqyqingfeng/Blog/issues/5)
- [ç†è§£JavaScript ä¸­çš„æ‰§è¡Œä¸Šä¸‹æ–‡å’Œæ‰§è¡Œæ ˆ](https://muyiy.cn/blog/1/1.1.html#%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E7%B1%BB%E5%9E%8B) 
- [JavaScriptæ·±å…¥ä¹‹ä½œç”¨åŸŸé“¾](https://github.com/mqyqingfeng/Blog/issues/6) 
- [å˜é‡ä½œç”¨åŸŸï¼Œé—­åŒ… -- ç°ä»£ JS æ•™ç¨‹](https://zh.javascript.info/closure)
- [å‡½æ•°ä½œç”¨åŸŸå’Œé—­åŒ…](https://yleave.github.io/2021/01/12/JS/%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E9%97%AD%E5%8C%85/%E5%87%BD%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%92%8C%E9%97%AD%E5%8C%85/#%E9%97%AD%E5%8C%85)




<Comment />
